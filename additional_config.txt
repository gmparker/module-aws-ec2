#configure postgreSQL
sudo su - postgres
psql

CREATE USER kong WITH PASSWORD 'P@ssw0rd!'; 
CREATE DATABASE kong OWNER kong;

exit
exit

#copy kong.conf.default file
sudo cp /etc/kong/kong.conf.default /etc/kong/kong2.conf

#create kong.conf file
echo "admin_listen = *:8001 reuseport backlog=16384, *:8444 http2 ssl reuseport backlog=16384" | sudo tee -a /etc/kong/kong.conf
echo "database = postgres" | sudo tee -a /etc/kong/kong.conf
echo "pg_host = 127.0.0.1" | sudo tee -a /etc/kong/kong.conf
echo "pg_port = 5432" | sudo tee -a /etc/kong/kong.conf
echo "pg_timeout = 5000" | sudo tee -a /etc/kong/kong.conf
echo "pg_user = kong" | sudo tee -a /etc/kong/kong.conf
echo 'pg_password = P@ssw0rd!' | sudo tee -a /etc/kong/kong.conf
echo "pg_database = kong" | sudo tee -a /etc/kong/kong.conf

#copy conf file then rm
sudo cp /var/lib/pgsql/data/pg_hba.conf /var/lib/pgsql/data/pg_hba.conf.bak
sudo rm /var/lib/pgsql/data/pg_hba.conf

echo "local   all             postgres                                peer" | sudo tee -a /var/lib/pgsql/data/pg_hba.conf
echo "local   all             all                                     peer" | sudo tee -a /var/lib/pgsql/data/pg_hba.conf
echo "host    all             all             127.0.0.1/32            md5" | sudo tee -a /var/lib/pgsql/data/pg_hba.conf


#Restart postgresql
sudo systemctl restart postgresql

# Run kong migrations bootstrap
sudo /usr/local/bin/kong migrations bootstrap -c /etc/kong/kong.conf

# Start kong
sudo /usr/local/bin/kong start -c /etc/kong/kong.conf





sudo cd /home/kong

wget https://github.com/prabago/kong-plugin-jwt-auth-rbac/archive/refs/heads/master.zip
unzip master.zip

cd kong-plugin-jwt-auth-rbac-master

luarocks make kong-plugin-jwt-auth-rbac-0.1.0-1.rockspec --local

cd /home/ec2-user/.luarocks/share/lua/5.1/kong/plugins/jwt-auth-rbac

sudo nano handler.lua

--local BasePlugin = require "
--local JWTAuthHandler = BasePlugin:extend()
--JWTAuthHandler.PRIORITY = 950
--JWTAuthHandler.VERSION = "0.1.0"


local JWTAuthHandler = {
  VERSION  = "0.1.0",
  PRIORITY = 950,
}

#modify schema.lua file
sudo cp schema.lua schema.lua.bak
sudo rm schema.lua
sudo nano schema.lua

local typedefs = require "kong.db.schema.typedefs"

return {
  name = "jwt-auth-rbac",
  fields = {
    { consumer = typedefs.no_consumer },
    { protocols = typedefs.protocols_http },
    { config = {
        type = "record",
        fields = {
    {roles = { type = "array", elements = { type = "string" }, }, },
    {roles_claim_name = {type = "string", default = "roles"}},
    {msg_error_any = {type = "string", default = "To be able to use this service you must have at least one of the roles configured"}},
    {msg_error_all = {type = "string", default = "In order to use this service you must match all the roles configured with the associated ones in the JWT token"}},
    {msg_error_not_roles_claimed = {type = "string", default = "The claim roles are not informed in the JWT token"}},
    {policy = {type = "string", default = "any", one_of = {"any", "all"}}}
        },
      },
    },
  },
}





echo "lua-package-path = /home/ec2-user/.luarocks/share/lua/5.1/?.lua;;" | sudo tee -a /etc/kong/kong.conf
echo "plugins = bundled,jwt-auth-rbac" | sudo tee -a /etc/kong/kong.conf
sudo nano /etc/kong/kong.conf


sudo /usr/local/bin/kong restart
